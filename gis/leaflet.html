<html>

<head>
    <title>Leaflet</title>
    <!-- <link rel="stylesheet" href="https://cdn.skypack.dev/leaflet/dist/leaflet.css"> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0-beta.0/dist/leaflet.css">
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        #map {
            height: 100vh
        }

        /* https://gis.stackexchange.com/questions/149062/display-tile-grid-borders-with-leaflet-visual-debugging */
        .leaflet-tile {
            border: solid red 1px;
        }
    </style>
</head>

<body>
    <!-- <div id="map" style="height: 100vh"></div> -->
    <div id="map"></div>
    <script type="module">
        import * as util from '../src/utils.js'
        import * as gis from '../src/gis.js'

        // import L from 'https://cdn.skypack.dev/leaflet'
        // import L from 'https://cdn.skypack.dev/leaflet@1.8.0-beta.0'
        import * as L from 'https://unpkg.com/leaflet@1.8.0-beta.0/dist/leaflet-src.esm.js'

        let [lon, lat, Z] = [-105.941109, 35.68222, 13]
        // const map = L.map('map').setView([lat, lon], Z)
        const map = L.map('map', {
            zoomDelta: 0.25, //0.1
            zoomSnap: 0,
        }).setView([lat, lon], Z)

        L.tileLayer(gis.template('osm'), {
            attribution: gis.attribution('osm'),
        }).addTo(map)

        const bounds = centerTileBounds()
        const rectangle = L.rectangle(bounds, { color: 'black' })
            .bindPopup(layer => centerTileString())
            .addTo(map)

        map.on('zoomend', ev => {
            update(ev)
        })
        map.on('moveend', ev => {
            update(ev)
        })

        function centerTileString() {
            const [X, Y, Z] = centerTileXYZ()
            return `X:${X},  Y:${Y}, Z:${Z}`
        }
        function centerTileXYZ() {
            const { lat, lng: lon } = map.getCenter()
            const Z = Math.round(map.getZoom())
            // const Z = Math.round(map.getZoom()) // if fractional zoom
            const [X, Y] = gis.lonlatz2xy(lon, lat, Z)
            return [X, Y, Z]
        }
        function centerTileBounds() {
            const [X, Y, Z] = centerTileXYZ()
            const bbox = gis.xyz2bbox(X, Y, Z)
            return gis.latlon(gis.bboxBounds(bbox))
        }
        function update(ev) {
            // if (ev.type === 'moveend') console.log('moved')
            // console.log('event', ev.type)
            rectangle.closePopup()
            const bounds = centerTileBounds()
            rectangle.setBounds(bounds)
        }

        util.toWindow({ L, util, map })

    </script>
</body>

</html>